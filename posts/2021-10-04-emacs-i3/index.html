<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Getting a consistent set of keybindings between i3 and Emacs</title>
    <meta name="description" content="Freedom is a state of mind">
    <meta name="author" content='SqrtMinusOne'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://sqrtminusone.xyz/favicon.ico">
    

    
        
    

    <script defer data-domain="sqrtminusone.xyz" src="https://plausible.sqrtminusone.xyz/js/plausible.js"></script>

</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" href="https://sqrtminusone.xyz/" title="SqrtMinusOne">
          
          SqrtMinusOne
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/" title="Index">
                        Index
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/posts/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/configs/readme" title="Configs">
                        Configs
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<script defer language="javascript" type="text/javascript"  src="/js/dynamic-toc.js"></script>
<div class="root">
    <h1 id="title-small-screen">Getting a consistent set of keybindings between i3 and Emacs</h1>
    <div class="container" id="actual-content">
        <h1 id="title-large-screen">Getting a consistent set of keybindings between i3 and Emacs</h1>
        <h2 id="intro">Intro</h2>
<p>One advantage of EXWM for an Emacs user is that EXWM gives one set of keybindings to manage both Emacs windows and X windows. In every other WM, like my preferred <a href="https://i3wm.org">i3wm</a>, two orthogonal keymaps seem to be necessary. But, as both programs are quite customizable, I want to see whether I can replicate at least some part of the EXWM goodness in i3.</p>
<p>But why not just use EXWM? One key reason is that to my taste (and perhaps on my hardware) EXWM didn&rsquo;t feel snappy enough. Also, I really like i3&rsquo;s tree-based layout structure; I feel like it fits my workflow much better than anything else I tried, including the master/stack paradigm of <a href="https://xmonad.org/">XMonad</a>â€‹, for instance.</p>
<p>One common point of criticism of i3 is that it is not extensible enough, especially compared to WMs that are configured in an actual programing language, like the mentioned XMonad, <a href="http://www.qtile.org/">Qtile</a>, <a href="https://awesomewm.org/">Awesome</a>, etc. But I think i3&rsquo;s extensibility is underappreciated, although the contents of this article may lie closer to the limits of how far one can go there.</p>
<p>Here is a small demo of how it currently works:</p>
<video controls width="100%">
<source src="/videos/i3-emacs-demo.mp4" type="video/mp4">
</video>
<h2 id="emacs-integration">Emacs integration</h2>
<p>What I&rsquo;m trying to do is actually quite simple, so I&rsquo;m somewhat surprised I didn&rsquo;t find anything similar on the Internet. But I didn&rsquo;t look too hard.</p>
<p>The basic idea is to launch a normal i3 command with <code>i3-msg</code> in case the current window is not Emacs, otherwise pass that command to Emacs with <code>emacsclient</code>. In Emacs, execute the command if possible, otherwise pass the command back to i3.</p>
<p>This may seem like a lot of overhead, but I didn&rsquo;t feel it even in the worst case (i3 -&gt; Emacs -&gt; i3), so at least in that regard, the interaction feels seamless. The only concern is that this command flow is vulnerable to Emacs getting stuck, but it is still much less of a problem than with EXWM.</p>
<p>One interesting observation here is that Emacs windows and X windows are sort of one-level entities, so I can talk just about &ldquo;windows&rdquo;.</p>
<p>At any rate, we need a script to do the i3 -&gt; Emacs part:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">[[</span> <span style="color:#008000;font-weight:bold">$(</span>xdotool getactivewindow getwindowname<span style="color:#008000;font-weight:bold">)</span> <span style="color:#666">=</span>~ ^emacs<span style="color:#666">(</span>:.*<span style="color:#666">)</span>?@.* <span style="color:#666">]]</span>; <span style="color:#008000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#19177c">command</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;(my/emacs-i3-integration \&#34;</span><span style="color:#19177c">$@</span><span style="color:#ba2121">\&#34;)&#34;</span>
</span></span><span style="display:flex;"><span>    emacsclient -e <span style="color:#ba2121">&#34;</span><span style="color:#19177c">$command</span><span style="color:#ba2121">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    i3-msg <span style="color:#19177c">$@</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">fi</span>
</span></span></code></pre></div><p>My <a href="https://sqrtminusone.xyz/configs/emacs/#custom-frame-title">Emacs frame title is set</a> to <code>emacs[:&lt;projectile-project-name&gt;]@&lt;hostname&gt;</code>, hence the regex. The script is saved to an executable called <code>emacs-i3-integration</code>.</p>
<p>For this to work, we need to make sure that Emacs starts a server, so here is an expression to do just that:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#19177c">add-hook</span> <span style="color:#19177c">&#39;after-init-hook</span> <span style="color:#00f">#&#39;</span><span style="color:#19177c">server-start</span>)
</span></span></code></pre></div><p>The function <code>my/emacs-i3-integration</code>, which is an entrypoint for the i3 integration, will be defined a bit later.</p>
<p>And here is a simple macro to do the Emacs -&gt; i3 part:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">defmacro</span> <span style="color:#19177c">i3-msg</span> (<span style="color:#008000">&amp;rest</span> <span style="color:#19177c">args</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#666">`</span>(<span style="color:#00f">start-process</span> <span style="color:#ba2121">&#34;emacs-i3-windmove&#34;</span> <span style="color:#800">nil</span> <span style="color:#ba2121">&#34;i3-msg&#34;</span> <span style="color:#666">,@</span><span style="color:#19177c">args</span>))
</span></span></code></pre></div><h2 id="handling-i3-commands">Handling i3 commands</h2>
<p>Now we have to handle the required set of i3 commands. It is worth noting here that I&rsquo;m not trying to implement a general mechanism to apply i3 commands to Emacs, rather I&rsquo;m implementing a small subset that I use in my i3 configuration and that maps reasonably to the Emacs concepts.</p>
<p>Also, I use <a href="https://github.com/emacs-evil/evil">evil-mode</a> and generally configure the software to have vim-style bindings where possible. So if you don&rsquo;t use evil-mode you&rsquo;d have to detangle the given functions from evil, but then, I guess, you do not use super+hjkl to manage windows either.</p>
<h3 id="focus"><code>focus</code></h3>
<p>First, for the <code>focus</code> command I want to move to an Emacs window in the given direction if there is one, otherwise move to an X window in the same direction. Fortunately, i3 and <code>windmove</code> have the same names for directions, so the function is rather straightforward.</p>
<p>One caveat here is that the minibuffer is always the bottom-most Emacs window, so it is necessary to check for that as well.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">defun</span> <span style="color:#19177c">my/emacs-i3-windmove</span> (<span style="color:#19177c">dir</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008000">let</span> ((<span style="color:#19177c">other-window</span> (<span style="color:#19177c">windmove-find-other-window</span> <span style="color:#19177c">dir</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#008000">if</span> (<span style="color:#008000">or</span> (<span style="color:#00f">null</span> <span style="color:#19177c">other-window</span>) (<span style="color:#00f">window-minibuffer-p</span> <span style="color:#19177c">other-window</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#19177c">i3-msg</span> <span style="color:#ba2121">&#34;focus&#34;</span> (<span style="color:#00f">symbol-name</span> <span style="color:#19177c">dir</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#19177c">windmove-do-window-select</span> <span style="color:#19177c">dir</span>))))
</span></span></code></pre></div><p>The relevant section of the i3 config looks like this:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+h <span style="color:#008000">exec</span> emacs-i3-integration focus left
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+j <span style="color:#008000">exec</span> emacs-i3-integration focus down
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+k <span style="color:#008000">exec</span> emacs-i3-integration focus up
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+l <span style="color:#008000">exec</span> emacs-i3-integration focus right
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Left <span style="color:#008000">exec</span> emacs-i3-integration focus left
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Down <span style="color:#008000">exec</span> emacs-i3-integration focus down
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Up <span style="color:#008000">exec</span> emacs-i3-integration focus up
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Right <span style="color:#008000">exec</span> emacs-i3-integration focus right
</span></span></code></pre></div><p>The Emacs function has to be called like that:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#19177c">my/emacs-i3-windmove</span> <span style="color:#19177c">&#39;right</span>)
</span></span></code></pre></div><h3 id="move"><code>move</code></h3>
<p>For the <code>move</code> command I want the following behavior:</p>
<ul>
<li>if there is space in the required direction, move the Emacs window there;</li>
<li>if there is no space in the required direction, but space in the orthogonal directions, move the Emacs window so that there is no more space in the orthogonal directions;</li>
<li>otherwise, move an X window (which has to be an Emacs frame).</li>
</ul>
<p>For the first part, <code>window-swap-states</code> with <code>windmove-find-other-window</code> do well enough.</p>
<p><code>evil-move-window</code> works well for the second part. By itself it doesn&rsquo;t behave quite like i3, for instance, <code>(evil-move-window 'right)</code> in a three-column split would move the window from the far left side to the far right side (bypassing center). Hence the combination as described here.</p>
<p>So here is a simple predicate which checks whether there is space in the given direction.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">defun</span> <span style="color:#19177c">my/emacs-i3-direction-exists-p</span> (<span style="color:#19177c">dir</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#19177c">some</span> (<span style="color:#008000">lambda</span> (<span style="color:#19177c">dir</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#008000">let</span> ((<span style="color:#19177c">win</span> (<span style="color:#19177c">windmove-find-other-window</span> <span style="color:#19177c">dir</span>)))
</span></span><span style="display:flex;"><span>            (<span style="color:#008000">and</span> <span style="color:#19177c">win</span> (<span style="color:#19177c">not</span> (<span style="color:#00f">window-minibuffer-p</span> <span style="color:#19177c">win</span>)))))
</span></span><span style="display:flex;"><span>        (<span style="color:#008000">pcase</span> <span style="color:#19177c">dir</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">&#39;width</span> <span style="color:#666">&#39;</span>(<span style="color:#19177c">left</span> <span style="color:#19177c">right</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">&#39;height</span> <span style="color:#666">&#39;</span>(<span style="color:#19177c">up</span> <span style="color:#19177c">down</span>)))))
</span></span></code></pre></div><p>And the implementation of the move command.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">defun</span> <span style="color:#19177c">my/emacs-i3-move-window</span> (<span style="color:#19177c">dir</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008000">let</span> ((<span style="color:#19177c">other-window</span> (<span style="color:#19177c">windmove-find-other-window</span> <span style="color:#19177c">dir</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#19177c">other-direction</span> (<span style="color:#19177c">my/emacs-i3-direction-exists-p</span>
</span></span><span style="display:flex;"><span>                          (<span style="color:#008000">pcase</span> <span style="color:#19177c">dir</span>
</span></span><span style="display:flex;"><span>                            (<span style="color:#19177c">&#39;up</span> <span style="color:#19177c">&#39;width</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#19177c">&#39;down</span> <span style="color:#19177c">&#39;width</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#19177c">&#39;left</span> <span style="color:#19177c">&#39;height</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#19177c">&#39;right</span> <span style="color:#19177c">&#39;height</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#008000">cond</span>
</span></span><span style="display:flex;"><span>     ((<span style="color:#008000">and</span> <span style="color:#19177c">other-window</span> (<span style="color:#19177c">not</span> (<span style="color:#00f">window-minibuffer-p</span> <span style="color:#19177c">other-window</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#19177c">window-swap-states</span> (<span style="color:#00f">selected-window</span>) <span style="color:#19177c">other-window</span>))
</span></span><span style="display:flex;"><span>     (<span style="color:#19177c">other-direction</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#19177c">evil-move-window</span> <span style="color:#19177c">dir</span>))
</span></span><span style="display:flex;"><span>     (<span style="color:#800">t</span> (<span style="color:#19177c">i3-msg</span> <span style="color:#ba2121">&#34;move&#34;</span> (<span style="color:#00f">symbol-name</span> <span style="color:#19177c">dir</span>))))))
</span></span></code></pre></div><p>The relevant section of the i3 config:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+h <span style="color:#008000">exec</span> emacs-i3-integration move left
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+j <span style="color:#008000">exec</span> emacs-i3-integration move down
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+k <span style="color:#008000">exec</span> emacs-i3-integration move up
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+l <span style="color:#008000">exec</span> emacs-i3-integration move right
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+Left <span style="color:#008000">exec</span> emacs-i3-integration move left
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+Down <span style="color:#008000">exec</span> emacs-i3-integration move down
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+Up <span style="color:#008000">exec</span> emacs-i3-integration move up
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+Right <span style="color:#008000">exec</span> emacs-i3-integration move right
</span></span></code></pre></div><h3 id="resize-and-balance-windows"><code>resize</code> and balance windows</h3>
<p>Next on the line are <code>resize grow</code> and <code>resize shrink</code>. <code>evil-window-</code> functions do nicely for this task.</p>
<p>This function also checks whether there is space to resize in the given direction with the help of the predicate defined above. The command is forwarded back to i3 if there is not.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">defun</span> <span style="color:#19177c">my/emacs-i3-resize-window</span> (<span style="color:#19177c">dir</span> <span style="color:#19177c">kind</span> <span style="color:#19177c">value</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008000">if</span> (<span style="color:#008000">or</span> (<span style="color:#19177c">one-window-p</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">not</span> (<span style="color:#19177c">my/emacs-i3-direction-exists-p</span> <span style="color:#19177c">dir</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#19177c">i3-msg</span> <span style="color:#ba2121">&#34;resize&#34;</span> (<span style="color:#00f">symbol-name</span> <span style="color:#19177c">kind</span>) (<span style="color:#00f">symbol-name</span> <span style="color:#19177c">dir</span>)
</span></span><span style="display:flex;"><span>              (<span style="color:#00f">format</span> <span style="color:#ba2121">&#34;%s px or %s ppt&#34;</span> <span style="color:#19177c">value</span> <span style="color:#19177c">value</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008000">setq</span> <span style="color:#19177c">value</span> (<span style="color:#00f">/</span> <span style="color:#19177c">value</span> <span style="color:#666">2</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008000">pcase</span> <span style="color:#19177c">kind</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#19177c">&#39;shrink</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#008000">pcase</span> <span style="color:#19177c">dir</span>
</span></span><span style="display:flex;"><span>         (<span style="color:#19177c">&#39;width</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">evil-window-decrease-width</span> <span style="color:#19177c">value</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#19177c">&#39;height</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">evil-window-decrease-height</span> <span style="color:#19177c">value</span>))))
</span></span><span style="display:flex;"><span>      (<span style="color:#19177c">&#39;grow</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#008000">pcase</span> <span style="color:#19177c">dir</span>
</span></span><span style="display:flex;"><span>         (<span style="color:#19177c">&#39;width</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">evil-window-increase-width</span> <span style="color:#19177c">value</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#19177c">&#39;height</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#19177c">evil-window-increase-height</span> <span style="color:#19177c">value</span>)))))))
</span></span></code></pre></div><p>Here I&rsquo;m following the default configuration of i3, which creates a &ldquo;submode&rdquo; to resize windows.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mode <span style="color:#ba2121">&#34;resize&#34;</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bindsym h <span style="color:#008000">exec</span> emacs-i3-integration resize shrink width <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>    bindsym j <span style="color:#008000">exec</span> emacs-i3-integration resize grow height <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>    bindsym k <span style="color:#008000">exec</span> emacs-i3-integration resize shrink height <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>    bindsym l <span style="color:#008000">exec</span> emacs-i3-integration resize grow width <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bindsym Shift+h <span style="color:#008000">exec</span> emacs-i3-integration resize shrink width <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Shift+j <span style="color:#008000">exec</span> emacs-i3-integration resize grow height <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Shift+k <span style="color:#008000">exec</span> emacs-i3-integration resize shrink height <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Shift+l <span style="color:#008000">exec</span> emacs-i3-integration resize grow width <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#408080;font-style:italic"># same bindings, but for the arrow keys</span>
</span></span><span style="display:flex;"><span>    bindsym Left  <span style="color:#008000">exec</span> emacs-i3-integration resize shrink width <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Down  <span style="color:#008000">exec</span> emacs-i3-integration resize grow height <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Up    <span style="color:#008000">exec</span> emacs-i3-integration resize shrink height <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Right <span style="color:#008000">exec</span> emacs-i3-integration resize grow width <span style="color:#666">10</span> px or <span style="color:#666">10</span> ppt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bindsym Shift+Left  <span style="color:#008000">exec</span> emacs-i3-integration resize shrink width <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Shift+Down  <span style="color:#008000">exec</span> emacs-i3-integration resize grow height <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Shift+Up    <span style="color:#008000">exec</span> emacs-i3-integration resize shrink height <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>    bindsym Shift+Right <span style="color:#008000">exec</span> emacs-i3-integration resize grow width <span style="color:#666">100</span> px or <span style="color:#666">100</span> ppt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bindsym equal <span style="color:#008000">exec</span> i3-emacs-balance-windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#408080;font-style:italic"># back to normal: Enter or Escape</span>
</span></span><span style="display:flex;"><span>    bindsym Return mode <span style="color:#ba2121">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>    bindsym Escape mode <span style="color:#ba2121">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">}</span>
</span></span></code></pre></div><p>Next, Emacs has a built-in function called <code>balance-windows</code>, but i3 doesn&rsquo;t. Fortunately, there is a Python package called <a href="https://github.com/atreyasha/i3-balance-workspace">i3-balance-workspace</a>, which performs a similar operation with i3&rsquo;s IPC. If you use Guix as I do, I&rsquo;ve written a <a href="https://github.com/SqrtMinusOne/channel-q/blob/master/i3-balance-workspace.scm">package definition</a>.</p>
<p>So here is a small wrapper which calls <code>i3_balance_workspace</code> and <code>M-x balance-windows</code> if the current window is Emacs.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">[[</span> <span style="color:#008000;font-weight:bold">$(</span>xdotool getactivewindow getwindowname<span style="color:#008000;font-weight:bold">)</span> <span style="color:#666">=</span>~ ^emacs<span style="color:#666">(</span>:.*<span style="color:#666">)</span>?@.* <span style="color:#666">]]</span>; <span style="color:#008000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    emacsclient -e <span style="color:#ba2121">&#34;(balance-windows)&#34;</span> &amp;
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>i3_balance_workspace
</span></span></code></pre></div><h3 id="layout-toggle-split"><code>layout toggle split</code></h3>
<p><a href="https://github.com/emacsorphanage/transpose-frame">transpose-frame</a> is a package to &ldquo;transpose&rdquo; the current Emacs windows layout, which behaves somewhat similar to the <code>layout toggle split</code> command in i3, so I&rsquo;ll use it as well.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">use-package</span> <span style="color:#19177c">transpose-frame</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:straight</span> <span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:commands</span> (<span style="color:#19177c">transpose-frame</span>))
</span></span></code></pre></div><p>The i3 config for this command:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+e <span style="color:#008000">exec</span> emacs-i3-integration layout toggle split
</span></span></code></pre></div><h3 id="the-entrypoint">The entrypoint</h3>
<p>Finally, the entrypoint for the Emacs integration. In addition to the commands defined above, it processes <code>split</code> and <code>kill</code> commands and passes every other command back to i3.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">defun</span> <span style="color:#19177c">my/emacs-i3-integration</span> (<span style="color:#19177c">command</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008000">pcase</span> <span style="color:#19177c">command</span>
</span></span><span style="display:flex;"><span>    ((<span style="color:#008000">rx</span> <span style="color:#19177c">bos</span> <span style="color:#ba2121">&#34;focus&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#19177c">my/emacs-i3-windmove</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#00f">intern</span> (<span style="color:#00f">elt</span> (<span style="color:#19177c">split-string</span> <span style="color:#19177c">command</span>) <span style="color:#666">1</span>))))
</span></span><span style="display:flex;"><span>    ((<span style="color:#008000">rx</span> <span style="color:#19177c">bos</span> <span style="color:#ba2121">&#34;move&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#19177c">my/emacs-i3-move-window</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#00f">intern</span> (<span style="color:#00f">elt</span> (<span style="color:#19177c">split-string</span> <span style="color:#19177c">command</span>) <span style="color:#666">1</span>))))
</span></span><span style="display:flex;"><span>    ((<span style="color:#008000">rx</span> <span style="color:#19177c">bos</span> <span style="color:#ba2121">&#34;resize&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#19177c">my/emacs-i3-resize-window</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#00f">intern</span> (<span style="color:#00f">elt</span> (<span style="color:#19177c">split-string</span> <span style="color:#19177c">command</span>) <span style="color:#666">2</span>))
</span></span><span style="display:flex;"><span>       (<span style="color:#00f">intern</span> (<span style="color:#00f">elt</span> (<span style="color:#19177c">split-string</span> <span style="color:#19177c">command</span>) <span style="color:#666">1</span>))
</span></span><span style="display:flex;"><span>       (<span style="color:#00f">string-to-number</span> (<span style="color:#00f">elt</span> (<span style="color:#19177c">split-string</span> <span style="color:#19177c">command</span>) <span style="color:#666">3</span>))))
</span></span><span style="display:flex;"><span>    (<span style="color:#ba2121">&#34;layout toggle split&#34;</span> (<span style="color:#19177c">transpose-frame</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#ba2121">&#34;split h&#34;</span> (<span style="color:#19177c">evil-window-split</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#ba2121">&#34;split v&#34;</span> (<span style="color:#19177c">evil-window-vsplit</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#ba2121">&#34;kill&#34;</span> (<span style="color:#19177c">evil-quit</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#00f">-</span> (<span style="color:#19177c">i3-msg</span> <span style="color:#19177c">command</span>))))
</span></span></code></pre></div><p>The rest of the relevant i3 config to do the splits:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+s <span style="color:#008000">exec</span> emacs-i3-integration split h
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+v <span style="color:#008000">exec</span> emacs-i3-integration split v
</span></span></code></pre></div><p>And to kill the window:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+Shift+q <span style="color:#008000">exec</span> emacs-i3-integration <span style="color:#008000">kill</span>
</span></span></code></pre></div><h3 id="switching-i3-tabs">Switching i3 tabs</h3>
<p>As I use i3&rsquo;s tabbed layout quite extensively, occasionally I want to switch out of the Emacs tab with one button, and that&rsquo;s where my integration may interfere.</p>
<p>As a workaround, I found a small Rust program called <a href="https://github.com/nikola-kocic/i3-switch-tabs">i3-switch-tabs</a>, which also communicates with i3 via its IPC to switch the top-level tab. I&rsquo;ve written a <a href="https://github.com/SqrtMinusOne/channel-q/blob/master/i3-switch-tabs.scm">Guix package definition</a> for that as well.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+period <span style="color:#008000">exec</span> i3-switch-tabs right
</span></span><span style="display:flex;"><span>bindsym <span style="color:#19177c">$mod</span>+comma <span style="color:#008000">exec</span> i3-switch-tabs left
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>So, how does all of that feel? Actually, I got used to that setup pretty quickly. Using <code>&lt;s-Q&gt;</code> to quit windows and the <code>&lt;s-r&gt;</code> submode to resize them is particularly nice. I&rsquo;ve seen people making hydras in Emacs to do the latter.</p>
<p>All of that would probably be easier to do in a WM which is configured in a programming language rather than in a self-cooked DSL, so I may try to replicate that somewhere else in an unknown time in the future. Meanwhile, it&rsquo;s pretty good.</p>

    </div>
    <div class="table-of-contents">
        <div class="table-of-contents-text">
            <b><a href="#">Table of Contents</a></b>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a></li>
    <li><a href="#emacs-integration">Emacs integration</a></li>
    <li><a href="#handling-i3-commands">Handling i3 commands</a>
      <ul>
        <li><a href="#focus"><code>focus</code></a></li>
        <li><a href="#move"><code>move</code></a></li>
        <li><a href="#resize-and-balance-windows"><code>resize</code> and balance windows</a></li>
        <li><a href="#layout-toggle-split"><code>layout toggle split</code></a></li>
        <li><a href="#the-entrypoint">The entrypoint</a></li>
        <li><a href="#switching-i3-tabs">Switching i3 tabs</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
        </div>
        <a id="unhide-all-button" class="hidden">&lt;Expand&gt;</a>
        <a id="hide-all-button" class="hidden">&lt;Collapse&gt;</a>
    </div>
</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
    </div>
    
    <div class="container text-center">
        <a href="https://sqrtminusone.xyz/" title="Pavel Korytov, 2022"><small>Pavel Korytov, 2022</small></a>
        
        <br>
        <a href="https://creativecommons.org/licenses/by/4.0/legalcode" title="Licensed under CC-BY 4.0"><small>Licensed under CC-BY 4.0</small></a>
        
    </div>
    
</div>
</body>
</html>
