<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Multiple Gmail accounts &amp; labels with Emacs</title>
    <meta name="description" content="Freedom is a state of mind">
    <meta name="author" content='SqrtMinusOne'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://sqrtminusone.xyz/favicon.ico">
    

    <script defer data-domain="sqrtminusone.xyz" src="https://plausible.sqrtminusone.xyz/js/plausible.js"></script>

</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" href="https://sqrtminusone.xyz/" title="SqrtMinusOne">
          
          SqrtMinusOne
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/" title="Index">
                        Index
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/posts/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/configs/readme" title="Configs">
                        Configs
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/emacs-packages/" title="Emacs packages">
                        Emacs packages
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<script defer language="javascript" type="text/javascript"  src="/js/dynamic-toc.js"></script>

<div class="root">
    <h1 id="title-small-screen">Multiple Gmail accounts &amp; labels with Emacs</h1>
    <div class="container" id="actual-content">
        <h1 id="title-large-screen">Multiple Gmail accounts &amp; labels with Emacs</h1>
        <h2 id="intro">Intro</h2>
<p>For quite some time, e-mail seemed like an anomaly in my workflow. I am a long time Gmail user, and my decade-old account has a somewhat formidable quantity of labels and filters. My messages are often assigned multiple labels, and I also like to keep only a bunch of messages in the inbox.</p>
<p>Although, in my opinion, Gmail web UI was and still is leagues ahead of many of its competitors and even allows keyboard-centric workflow, it&rsquo;s awkward to use with a keyboard-driven browser, and for no money on Earth I would enable browser notifications.</p>
<p>Any classical IMAP/SMTP client is hard to use in my case, because a message with multiple labels is copied to IMAP folders for each of the label plus the inbox folder, and the copies look like different messages from the client-side. For example, a message can be read in one label and unread in another.</p>
<p>For a few years, my solution was <a href="https://getmailspring.com/">Mailspring</a>, which provides first-class support for labels. However, it has a feature to deploy <a href="https://www.bbc.com/news/technology-56071437">spy pixels</a> on emails (and offers no protection from them, obviously), the client is Electron-based with a mouse-driven interface, and the sync engine was closed-source at the time.</p>
<p>So, I found an alternative in Emacs+notmuch+lieer and ditched one more proprietary app (the last big one I can&rsquo;t let go of is DataGrip).</p>
<figure><img src="/images/gmail/main.png">
</figure>

<figure><img src="/images/gmail/mail.png">
</figure>

<p>Notmuch&rsquo;s tags are just as advanced as Gmail&rsquo;s labels, so I have basically the same mail structure accessible from Emacs, Gmail Android client and even the web UI when I don&rsquo;t have access to the first two.</p>
<p>Also, I think the setup I describe here is pretty straightforward and less complex than many I encountered, but my impression is not the most reliable source of such knowledge.</p>
<p>In any case, what follows is a description of my current workflow with instructions of varying levels of precision of how to get there.</p>
<h2 id="setting-up">Setting up</h2>
<h3 id="gmail">Gmail</h3>
<p>Before we start, some setup is required for the Gmail account.</p>
<p>First, as there is no way to enable SMTP without IMAP on Gmail, you have to set &ldquo;Enable IMAP&rdquo; in the &ldquo;Forwarding and POP/IMAP&rdquo; tab in the settings. If you use two-factor auth, generate an <a href="https://support.google.com/accounts/answer/185833?hl=en">app password</a>.</p>
<p>Also, make sure your labels do not contain whitespaces because if they do, you will have to type them in quotes all the time.</p>
<h3 id="lieer">lieer</h3>
<p><a href="https://github.com/gauteh/lieer">lieer</a> (formerly gmailieer) is a program that uses Gmail API to download email and synchronize Gmail labels with notmuch tags. Because of its usage of Gmail API instead of IMAP, there are no problems with duplicating emails in different labels, etc.</p>
<p>As I need to use multiple versions of Python &amp; Node.js for other reasons, I manage my installations of them with <a href="https://anaconda.org">Anaconda</a> (Miniconda, to be precise). You may instead use <a href="https://docs.python.org/3/library/venv.html">venv</a> or even the system-wide installation of Python and omit the <code>conda</code> clauses, but in my experience Anaconda makes life easier in that regard.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Create an environment with the name &#34;mail&#34;</span>
</span></span><span style="display:flex;"><span>conda create --name mail
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Activate the environment</span>
</span></span><span style="display:flex;"><span>conda activate mail
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Install Python</span>
</span></span><span style="display:flex;"><span>conda install python
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Download and install lieer</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/gauteh/lieer.git
</span></span><span style="display:flex;"><span><span style="color:#008000">cd</span> lieer
</span></span><span style="display:flex;"><span>pip install .
</span></span></code></pre></div><p>After which we may check if the <code>gmi</code> executable is available:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>which gmi
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>/home/pavel/Programs/miniconda3/envs/mail/bin/gmi
</span></span></code></pre></div><h3 id="notmuch">Notmuch</h3>
<p><a href="https://notmuchmail.org/">Notmuch</a> is present in most of the package repositories, so you can install it with your package manager, which is <code>pacman</code> in my case.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo pacman -S notmuch
</span></span></code></pre></div><p>After the installation, run <code>notmuch setup</code>. That will inquire the parameters and create the <code>.notmuch-config</code> file with the answers.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Your full name <span style="color:#666">[</span>Pavel<span style="color:#666">]</span>: Pavel Korytov
</span></span><span style="display:flex;"><span>Your primary email address <span style="color:#666">[</span>pavel@pdsk.<span style="color:#666">(</span>none<span style="color:#666">)]</span>: thexcloud@gmail.com
</span></span><span style="display:flex;"><span>Additional email address <span style="color:#666">[</span>Press <span style="color:#ba2121">&#39;Enter&#39;</span> <span style="color:#008000;font-weight:bold">if</span> none<span style="color:#666">]</span>:
</span></span><span style="display:flex;"><span>Top-level directory of your email archive <span style="color:#666">[</span>/home/pavel/mail<span style="color:#666">]</span>: /home/pavel/Mail
</span></span><span style="display:flex;"><span>Tags to apply to all new messages <span style="color:#666">(</span>separated by spaces<span style="color:#666">)</span> <span style="color:#666">[</span>unread inbox<span style="color:#666">]</span>: new
</span></span><span style="display:flex;"><span>Tags to exclude when searching messages <span style="color:#666">(</span>separated by spaces<span style="color:#666">)</span> <span style="color:#666">[</span>deleted spam<span style="color:#666">]</span>:
</span></span></code></pre></div><p>It is important to set the <code>new</code> tag for the new messages instead of the default <code>unread</code> and <code>inbox</code>.</p>
<p>Next, add the rule to ignore JSON files to the <code>[new]</code> section of the <code>.notmuch-config</code> file, so it would look like this:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>new<span style="color:#666">]</span>
</span></span><span style="display:flex;"><span><span style="color:#19177c">tags</span><span style="color:#666">=</span>new
</span></span><span style="display:flex;"><span><span style="color:#19177c">ignore</span><span style="color:#666">=</span>/.*<span style="color:#666">[</span>.<span style="color:#666">](</span>json|lock|bak<span style="color:#666">)</span>$/
</span></span></code></pre></div><p>That is needed to ignore the lieer config files. Although, as I have noticed, notmuch is generally pretty good at detecting wrong files in its directories, an explicit ignore rule won&rsquo;t hurt.</p>
<p>Now, create the mail directory and run the <a href="https://notmuchmail.org/manpages/notmuch-new-1/">notmuch new</a> command. As notmuch has probably already noticed you, it uses the <a href="https://en.wikipedia.org/wiki/Maildir">maildir</a> format, which basically means that one message is stored in one file.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># The same directory mentioned in the 4th question</span>
</span></span><span style="display:flex;"><span>mkdir ~/Mail
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Initialize notmuch</span>
</span></span><span style="display:flex;"><span>notmuch new
</span></span></code></pre></div><h3 id="add-an-account">Add an account</h3>
<p>After that, we can create a directory for a mail account and initialize lieer.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000">cd</span> ~/Mail
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Use whatever name you want</span>
</span></span><span style="display:flex;"><span>mkdir thexcloud
</span></span><span style="display:flex;"><span><span style="color:#008000">cd</span> thexcloud
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Intialize lieer</span>
</span></span><span style="display:flex;"><span>gmi init thexcloud@gmail.com
</span></span></code></pre></div><p>Running <code>gmi init</code> will run an OAuth authentication to your Gmail account. The credentials will be stored in <code>.credentials.gmailieer.json</code> file, so make sure not to expose it somewhere.</p>
<p>We also can add a few settings for lieer, which will make life easier. First, dots seem to be less awkward to type than slashes for the nested tags:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gmi <span style="color:#008000">set</span> --replace-slash-with-dot
</span></span></code></pre></div><p>Then, we don&rsquo;t want the <code>new</code> tag to be pushed back to Gmail</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gmi <span style="color:#008000">set</span> --ignore-tags-local new
</span></span></code></pre></div><p>Now we can finally download the mail directory. To initiate the download, run</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gmi sync
</span></span></code></pre></div><p>The first download can easily take several hours, depending on the size of your email and the speed of your internet connection, but subsequent runs will be much faster.</p>
<p>The last thing to do here is to add the <code>gmi sync</code> command to notmuch&rsquo;s <a href="https://notmuchmail.org/manpages/notmuch-hooks-5/">pre-new hook</a>, so that the email will be synchronized on the <code>notmuch new</code> command.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Create the hooks folder</span>
</span></span><span style="display:flex;"><span>mkdir -p ~/Mail/.notmuch/hooks
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Create the file</span>
</span></span><span style="display:flex;"><span><span style="color:#008000">cd</span> ~/Mail/.notmuch/hooks
</span></span><span style="display:flex;"><span>cat &gt; pre-new <span style="color:#ba2121">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">eval &#34;$(conda shell.bash hook)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">conda activate mail
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">(cd /home/pavel/Mail/thexcloud/ &amp;&amp; gmi sync)
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x pre-new
</span></span></code></pre></div><p>Side note: as a hook for <code>conda</code> tends to be rather slow, I run the <code>gmi</code> command with system-wide Python as follows:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#bc7a00">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#bc7a00"></span><span style="color:#19177c">GMI</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;/home/pavel/Programs/miniconda3/envs/mail/bin/gmi&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">(</span><span style="color:#008000">cd</span> /home/pavel/Mail/thexcloud/ <span style="color:#666">&amp;&amp;</span> <span style="color:#19177c">$GMI</span> sync<span style="color:#666">)</span>
</span></span></code></pre></div><p>Which doesn&rsquo;t seem to cause any particular trouble in that case.</p>
<h3 id="emacs">Emacs</h3>
<p>There are plenty of different <a href="https://notmuchmail.org/frontends/">frontends</a> for notmuch (even GUI apps), but the one I&rsquo;m sticking with the Emacs.</p>
<p>Configuration for Emacs is pretty straightforward, but you probably want to use the notmuch package which came with the system package, because otherwise, you may end up with different versions of frontend and backend.</p>
<p>That&rsquo;s how it can be done with <code>use-package</code>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">use-package</span> <span style="color:#19177c">notmuch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:ensure</span> <span style="color:#800">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:commands</span> (<span style="color:#19177c">notmuch</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:config</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#19177c">add-hook</span> <span style="color:#19177c">&#39;notmuch-hello-mode-hook</span>
</span></span><span style="display:flex;"><span>            (<span style="color:#008000">lambda</span> () (<span style="color:#19177c">display-line-numbers-mode</span> <span style="color:#666">0</span>))))
</span></span></code></pre></div><p>The only notable observation here is that <code>display-line-numbers-mode</code> seems to break formatting of the <code>notmuch-hello</code> page.</p>
<p>If you use evil-mode, you also should enable the <a href="https://github.com/emacs-evil/evil-collection/blob/master/modes/notmuch/evil-collection-notmuch.el">evil-collection mode for notmuch</a>.</p>
<p>Now run <code>M-x notmuch</code> and the <code>notmuch-hello</code> page should appear. Running <code>notmuch-poll-and-refresh-this-buffer</code> (<code>gR</code> with evil bindings) will run the <code>notmuch new</code> command and refresh the buffer. All the syncronized messages should be present.</p>
<p>I should note that <a href="https://notmuchmail.org/notmuch-emacs/">notmuch frontend for Emacs</a> is the most user-friendly Emacs app I have seen so far. UI, commands and keybindings are self-descriptive, all the options can be configured with the build-in <code>customize</code> interface. It may be useful to look through <a href="https://notmuchmail.org/emacstips/">emacs tips</a> at the official site and <a href="https://notmuchmail.org/manpages/">notmuch man pages</a>, in particular <a href="https://notmuchmail.org/manpages/notmuch-search-terms-7/">syntax for notmuch queries</a>.</p>
<h3 id="reading-mail">Reading mail</h3>
<p><code>notmuch-search-show-thread</code> (<code>RET</code>) opens the thread under the cursor.</p>
<p><code>notmuch-show-view-part</code> (<code>. v</code> with evil) opens an attachment with associations defined in <a href="https://linux.die.net/man/4/mailcap">.mailcap</a> file. Mine looks like this:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>audio/*; mpc add %s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image/*; feh %s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>application/msword; /usr/bin/xdg-open %s
</span></span><span style="display:flex;"><span>application/pdf; zathura %s
</span></span><span style="display:flex;"><span>application/postscript ; zathura %s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>text/html; /usr/bin/xdg-open %s
</span></span></code></pre></div><p>Here watch out for the last line, default version of which may be set as follows:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>text/html; /usr/bin/xdg-open %s ; copiousoutput
</span></span></code></pre></div><p>Which causes a temporary file to be deleted before it could be opened because recent versions of <code>xdg-open</code> do not block the input.</p>
<p>As expected, Emacs mail reader does not trigger any <a href="https://www.emailprivacytester.com/">spy pixels or other tracking contents of email</a> (not any I know of, at least). However, opening an HTML email in a browser will even run embedded JavaScript. Therefore, <strong>in no case open emails you do not trust with <code>xdg-open</code></strong>. Even if you use NoScript, the browser will still load all the CSS, videos and even iframes, which can be used to track you.</p>
<p>Even Gmail web UI is preferable to view the message in a browser, because the former blocks most of the malicious stuff and does not seem to leak your IP to the sender, for what it&rsquo;s worth.</p>
<h3 id="sending-mail">Sending mail</h3>
<p>To start composing a message, run <code>notmuch-mua-new-mail</code> (<code>C</code> with evil bindings).</p>
<p>After doing so, <code>C-c C-c</code> will run <code>notmuch-mua-send-and-exit</code>, which will invoke the function stated in the <code>message-send-mail-function</code> variable. The default value of the variable is <code>sendmail-query-once</code>, which will inquire the parameters and save them as custom variables.</p>
<p>If SMTP is used, <code>send-mail-function</code> will be set to the one from the built-it <a href="https://www.emacswiki.org/emacs/SendingMail">smtpmail</a> package. SMTP parameters for Gmail are listed <a href="https://support.google.com/mail/answer/7126229?hl=en">here</a>.</p>
<p>Authorization parameters will be saved to your <a href="https://www.emacswiki.org/emacs/GnusAuthinfo">authinfo</a> file. If you didn&rsquo;t have one, the plaintext <code>.authinfo</code> will be created, so it&rsquo;s reasonable to encrypt it:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000">cd</span> ~
</span></span><span style="display:flex;"><span>gpg -o .authinfo.gpg -c --cipher-algo AES256 .authinfo
</span></span></code></pre></div><p>However, if you plan to use multiple accounts with different SMTP servers, it makes more sense to use something like <a href="https://marlam.de/msmtp/msmtp.html">MSMTP</a> to manage multiple accounts. Here are a couple of examples (<a href="https://www.reddit.com/r/emacs/comments/9piml5/a_few_quick_emacsnotmuch_questions/e83zcck?utm_source=share&amp;utm_medium=web2x&amp;context=3">1</a>, <a href="https://www.reddit.com/r/emacs/comments/9piml5/a_few_quick_emacsnotmuch_questions/e84otah?utm_source=share&amp;utm_medium=web2x&amp;context=3">2</a>) how to do that.</p>
<p>Another alternative for Gmail is to use <a href="https://github.com/gauteh/lieer/wiki/GNU-Emacs-and-Lieer">lieer as sendmail program</a>. That may make sense if you don&rsquo;t want to enable IMAP and SMTP on your account.</p>
<p>There are also <a href="https://notmuchmail.org/emacstips/#index13h2">a bunch of ways</a> to set up address completion if the built-in completion based on notmuch database does not suffice.</p>
<p>I also use <a href="https://github.com/mhayashi1120/Emacs-langtool">LanguageTool for Emacs</a> to do a spell checking of important emails (integrations like that really make Emacs shine). For some reason, developers don&rsquo;t give a link to download the server on the frontpage, so <a href="https://dev.languagetool.org/http-server">here it is</a>. And here is the relevant part of my Emacs config:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">use-package</span> <span style="color:#19177c">langtool</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:straight</span> <span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:commands</span> (<span style="color:#19177c">langtool-check</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#008000">:config</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008000">setq</span> <span style="color:#19177c">langtool-language-tool-server-jar</span> <span style="color:#ba2121">&#34;/home/pavel/Programs/LanguageTool-5.1/languagetool-server.jar&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008000">setq</span> <span style="color:#19177c">langtool-mother-tongue</span> <span style="color:#ba2121">&#34;ru&#34;</span>))
</span></span></code></pre></div><p>As a last note here, to set up a signature create the <code>.signature</code> file in the <code>$HOME</code> directory. If you need more complex logic here, for instance, different signatures for different accounts, you can put an arbitrary expression to the <code>mail-signature</code> variable or apply <a href="https://notmuchmail.org/emacstips/#index16h2">this gnus-alias tip</a>.</p>
<h2 id="another-account">Another account</h2>
<h3 id="adding-an-account">Adding an account</h3>
<p>Now we can send and receive mail from one account. Adding another account is also pretty easy.</p>
<p>If another account is Gmail, the process starts the same as before:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Create a directory</span>
</span></span><span style="display:flex;"><span>mkdir -p ~/Mail/progin6304
</span></span><span style="display:flex;"><span><span style="color:#008000">cd</span> ~/Mail/progin6304
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># OAuth</span>
</span></span><span style="display:flex;"><span>gmi init progin6304@gmail.com
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Settings</span>
</span></span><span style="display:flex;"><span>gmi <span style="color:#008000">set</span> --replace-slash-with-dot
</span></span></code></pre></div><p>However, before running <code>gmi sync</code> for the second account, we want to make sure that we can distinguish the message from different accounts. To do that, I add the <code>main</code> for the main account and <code>progin</code> for the second account. We also don&rsquo;t want these labels to be pushed:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000">cd</span> ~/Mail/thexcloud
</span></span><span style="display:flex;"><span>gmi <span style="color:#008000">set</span> --ignore-tags-local new,mail,progin
</span></span><span style="display:flex;"><span><span style="color:#008000">cd</span> ~/Mail/progin6304
</span></span><span style="display:flex;"><span>gmi <span style="color:#008000">set</span> --ignore-tags-local new,mail,progin
</span></span></code></pre></div><p>Now we can use notmuch&rsquo;s <code>post-new</code> hook to tag the messages based on their folder as follows:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000">cd</span> ~/Mail/.notmuch/hooks
</span></span><span style="display:flex;"><span>cat &gt; post-new <span style="color:#ba2121">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">notmuch tag +main &#34;path:thexcloud/** AND tag:new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">notmuch tag +progin &#34;path:progin6304/** AND tag:new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">notmuch tag -new &#34;tag:new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x post-new
</span></span></code></pre></div><p>Now it finally makes sense why we wanted to use the <code>new</code> tag in the first place. In principle, any kind of tagging logic can be applied here, but for the reasons I stated earlier, I prefer to set up filters in the Gmail web interface.</p>
<p>The last thing to do is to modify the <code>pre-new</code> hook:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#bc7a00">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#bc7a00"></span><span style="color:#19177c">GMI</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;/home/pavel/Programs/miniconda3/envs/mail/bin/gmi&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">(</span><span style="color:#008000">cd</span> /home/pavel/Mail/thexcloud/ <span style="color:#666">&amp;&amp;</span> <span style="color:#19177c">$GMI</span> sync<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span><span style="color:#666">(</span><span style="color:#008000">cd</span> /home/pavel/Mail/progin6304/ <span style="color:#666">&amp;&amp;</span> <span style="color:#19177c">$GMI</span> sync<span style="color:#666">)</span>
</span></span></code></pre></div><p>After which we can finally tag the existing messages and download ones from the new account</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>notmuch tag +main <span style="color:#ba2121">&#34;path:thexcloud/**&#34;</span>
</span></span><span style="display:flex;"><span>notmuch new
</span></span></code></pre></div><p>The obvious problem, however, is that the messages are fetched sequentially, which is rather slow. A solution is to use something like <a href="http://www.gnu.org/software/parallel/">GNU Parallel</a>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#bc7a00">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#bc7a00"></span><span style="color:#19177c">GMI</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;/home/pavel/Programs/miniconda3/envs/mail/bin/gmi&#34;</span>
</span></span><span style="display:flex;"><span>parallel -j0 <span style="color:#ba2121">&#34;(cd /home/pavel/Mail/{}/ &amp;&amp; </span><span style="color:#19177c">$GMI</span><span style="color:#ba2121"> sync)&#34;</span> ::: thexcloud progin6304
</span></span></code></pre></div><p>I haven&rsquo;t encountered any trouble with that solution so far (and I don&rsquo;t see anything thread-unsafe in the lieer code), but I&rsquo;ll keep an eye on that.</p>
<p>In principle, it shouldn&rsquo;t be too hard to add a normal IMAP account as well with <a href="https://isync.sourceforge.io/mbsync.html">mbsync</a>, but I expect it would require something like iterating through the directory structure and assigning notmuch labels based on that. I&rsquo;ll probably try that some time in the future.</p>
<h3 id="emacs">Emacs</h3>
<p>With that done, I also want separate entries on the start page for each of the accounts. Doing that is easy enough, just modify the <code>notmuch-saved-searches</code> variable with <code>customize-group</code> or like this:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#008000">setq</span> <span style="color:#19177c">notmuch-saved-searches</span>
</span></span><span style="display:flex;"><span>   <span style="color:#666">&#39;</span>((<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;inbox (main)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:inbox AND tag:main&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;unread (main)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:unread AND tag:main&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;sent (main)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:sent AND tag:main&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;all mail (main)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:main&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;inbox (progin)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:inbox AND tag:progin&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;unread (progin)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:unread AND tag:progin&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;sent (progin)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:sent AND tag:progin&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;all main (progin)&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:progin&#34;</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008000">:name</span> <span style="color:#ba2121">&#34;drafts&#34;</span> <span style="color:#008000">:query</span> <span style="color:#ba2121">&#34;tag:draft&#34;</span>)))
</span></span></code></pre></div><h2 id="notification-for-new-messages">Notification for new messages</h2>
<p>Now, we can send and receive mail, but we also probably want notifications for new emails. To do that, I wrote a simple script:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#bc7a00">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#bc7a00"></span><span style="color:#408080;font-style:italic"># To run notify-send from cron</span>
</span></span><span style="display:flex;"><span><span style="color:#008000">export</span> <span style="color:#19177c">DISPLAY</span><span style="color:#666">=</span>:0
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># A file with last time of sync</span>
</span></span><span style="display:flex;"><span><span style="color:#19177c">CHECK_FILE</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;/home/pavel/Mail/.last_check&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#19177c">QUERY</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;tag:unread&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#19177c">ALL_QUERY</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;tag:unread&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># If the file exists, check also the new messages from the last sync</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">[</span> -f <span style="color:#ba2121">&#34;</span><span style="color:#19177c">$CHECK_FILE</span><span style="color:#ba2121">&#34;</span> <span style="color:#666">]</span>; <span style="color:#008000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#19177c">DATE</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>cat <span style="color:#ba2121">&#34;</span><span style="color:#19177c">$CHECK_FILE</span><span style="color:#ba2121">&#34;</span><span style="color:#008000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#19177c">QUERY</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#19177c">$QUERY</span><span style="color:#ba2121"> and date:@</span><span style="color:#19177c">$DATE</span><span style="color:#ba2121">..&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>notmuch new
</span></span><span style="display:flex;"><span><span style="color:#19177c">NEW_UNREAD</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>notmuch count <span style="color:#ba2121">&#34;</span><span style="color:#19177c">$QUERY</span><span style="color:#ba2121">&#34;</span><span style="color:#008000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#19177c">ALL_UNREAD</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>notmuch count <span style="color:#ba2121">&#34;</span><span style="color:#19177c">$ALL_QUERY</span><span style="color:#ba2121">&#34;</span><span style="color:#008000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># I don&#39;t really care if there are unread messages for which I&#39;ve already seen a notification</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">[</span> <span style="color:#19177c">$NEW_UNREAD</span> -gt <span style="color:#666">0</span> <span style="color:#666">]</span>; <span style="color:#008000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#19177c">MAIN_UNREAD</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>notmuch count <span style="color:#ba2121">&#34;tag:unread AND tag:main&#34;</span><span style="color:#008000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#19177c">PROGIN_UNREAD</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>notmuch count <span style="color:#ba2121">&#34;tag:unread AND tag:progin&#34;</span><span style="color:#008000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000">read</span> -r -d <span style="color:#ba2121">&#39;&#39;</span> NOTIFICATION <span style="color:#ba2121">&lt;&lt;EOM
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">$NEW_UNREAD new messages
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">$MAIN_UNREAD thexcloud@gmail.com
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">$PROGIN_UNREAD progin6304@gmail.com
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">$ALL_UNREAD total
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">EOM</span>
</span></span><span style="display:flex;"><span>    notify-send <span style="color:#ba2121">&#34;New Mail&#34;</span> <span style="color:#ba2121">&#34;</span><span style="color:#19177c">$NOTIFICATION</span><span style="color:#ba2121">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Save sync timestamp</span>
</span></span><span style="display:flex;"><span><span style="color:#008000">echo</span> <span style="color:#ba2121">&#34;</span><span style="color:#008000;font-weight:bold">$(</span>date +%s<span style="color:#008000;font-weight:bold">)</span><span style="color:#ba2121">&#34;</span> &gt; <span style="color:#19177c">$CHECK_FILE</span>
</span></span></code></pre></div><p>The script is launched with cron every 5 minutes:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>*/5 * * * * bash /home/pavel/bin/scripts/check-email
</span></span></code></pre></div><p>Here&rsquo;s how the notification looks like:
<img src="/images/gmail/notification.png" alt=""></p>
<h2 id="caveats">Caveats</h2>
<ul>
<li><a href="https://github.com/gauteh/lieer#caveats">lieer</a> has an extensive list of caveats concerning Gmail API</li>
<li>Make sure that you understand the <a href="https://github.com/gauteh/lieer#changing-ignored-tags-and-translation-after-initial-sync">implications</a> of lieer&rsquo;s <code>--ignore-tags-locally</code> and <code>--ignore-tags-remote</code></li>
<li>If two of your accounts receive the same email, it will be stored as one email in notmuch, so tags from these accounts will be merged and pushed back on the next sync. To solve that, you can set tags from one account to be ignored on the rest of the accounts</li>
<li>A sent email is being downloaded again on the next sync. Not a great deal, but it is somewhat annoying to download recently sent attachments.</li>
</ul>

    </div>
    <div class="table-of-contents">
        <div class="table-of-contents-text">
            <b><a href="#">Table of Contents</a></b>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a></li>
    <li><a href="#setting-up">Setting up</a>
      <ul>
        <li><a href="#gmail">Gmail</a></li>
        <li><a href="#lieer">lieer</a></li>
        <li><a href="#notmuch">Notmuch</a></li>
        <li><a href="#add-an-account">Add an account</a></li>
        <li><a href="#emacs">Emacs</a></li>
        <li><a href="#reading-mail">Reading mail</a></li>
        <li><a href="#sending-mail">Sending mail</a></li>
      </ul>
    </li>
    <li><a href="#another-account">Another account</a>
      <ul>
        <li><a href="#adding-an-account">Adding an account</a></li>
        <li><a href="#emacs">Emacs</a></li>
      </ul>
    </li>
    <li><a href="#notification-for-new-messages">Notification for new messages</a></li>
    <li><a href="#caveats">Caveats</a></li>
  </ul>
</nav>
        </div>
        <a id="unhide-all-button" class="hidden">&lt;Expand&gt;</a>
        <a id="hide-all-button" class="hidden">&lt;Collapse&gt;</a>
    </div>
</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
    </div>
    
    <div class="container text-center">
        
        
        <a href="https://creativecommons.org/licenses/by/4.0/legalcode" title="Licensed under CC-BY 4.0"><small>Licensed under CC-BY 4.0</small></a>
        
        |
        
        
        <a href="https://plausible.io/" title="Uses Plausible Analytics"><small>Uses Plausible Analytics</small></a>
        
        
        <br>
        
        <a href="https://sqrtminusone.xyz/" title="Pavel Korytov, 2024"><small>Pavel Korytov, 2024</small></a>
    </div>
    
</div>
</body>
</html>
